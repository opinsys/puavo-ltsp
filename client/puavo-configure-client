#!/usr/bin/ruby

require 'erb'

def delete_file(file)
  if File.exists?(file)
    File.delete(file)
  end
end

def read_file(file)
  if File.exists?(file)
    return File.read(file).chomp
  end

  return ""
end

puavo_device_type = ARGV[0]

if (!puavo_device_type)
  if File.exists?("/etc/puavo/hosttype")
    puavo_device_type = File.read('/etc/puavo/hosttype').chomp
  end
end

if puavo_device_type == 'unregistered'
  `hostname unregistered`
  `echo unregistered > /proc/sys/kernel/hostname`
  `echo unregistered > /etc/hostname`

  exit(0)
end

@ldap_master       = read_file('/etc/puavo/ldap/master')
@ldap_slave        = read_file('/etc/puavo/ldap/slave')
@ldap_base         = read_file('/etc/puavo/ldap/base')
@kerberos_master   = read_file('/etc/puavo/kerberos/master')
@kerberos_realm    = read_file('/etc/puavo/kerberos/realm' )
@kerberos_toprealm = read_file('/etc/puavo/kerberos/toprealm' )
@puavo_hostname    = read_file('/etc/puavo/hostname')
@puavo_domain      = read_file('/etc/puavo/domain')
@puavo_topdomain   = read_file('/etc/puavo/topdomain')

def write_config(filename, version=nil, secure=false)
  begin
    template_file = filename

    if version
      template_file = "#{filename}-#{version}"
    end

    conf_template = File.read("/usr/share/puavo-ltsp-client/templates#{template_file}")
    conf = ERB.new(conf_template, 0, "%<>")

    perm = secure ? 0600 : 0644

    File.open(filename, "w", perm) do |f|
      f.write conf.result
    end

    File.chmod(perm, filename)
  rescue Exception => e
    $stderr.puts "FAILED to write: #{filename} from /usr/share/puavo-ltsp-client/templates#{template_file}: #{e}"
  end
end

begin
  Dir.mkdir('/etc/cups')
rescue Errno::EEXIST
end

`hostname #{@puavo_hostname}`
`echo #{@puavo_hostname} > /proc/sys/kernel/hostname`
`echo #{@puavo_hostname} > /etc/hostname`

write_config("/etc/hosts")

case puavo_device_type
  when "thinclient"
    write_config("/etc/nsswitch.conf", "extrausers")
    write_config("/etc/pam.d/lightdm", "thinclient")
    write_config("/etc/pam.d/lightdm-autologin", "thinclient")
    write_config("/etc/ldap/ldap.conf")
    write_config("/etc/krb5.conf")
    write_config("/etc/idmapd.conf")
    write_config("/etc/default/nfs-common")
    write_config("/etc/init/gssd.conf", "userprincipal")
    write_config("/etc/cups/client.conf")

    delete_file('/usr/share/dbus-1/system-services/fi.epitest.hostap.WPASupplicant.service')
    delete_file('/usr/share/dbus-1/system-services/fi.w1.wpa_supplicant1.service')

    # Temporary hack until ltsp-lightdm is not used anymore
    `cp /usr/lib/puavo-ltsp-client/puavo-thin-guest-account /usr/sbin/guest-account`
    `cp /usr/lib/puavo-ltsp-client/puavo-desktop-guest-session /usr/share/ltsp-lightdm/xsession-stub`

    # Temporary hack to get ltspfs working with thin guest sessions
    write_config("/lib/udev/ltspfs_entry")
    File.chmod(0755, "/lib/udev/ltspfs_entry")
  when "fatclient"
    write_config("/etc/nsswitch.conf", "extrausers")
    write_config("/etc/pam.d/lightdm", "fatclient")
    write_config("/etc/pam.d/lightdm-autologin", "fatclient")
    write_config("/etc/ldap/ldap.conf")
    write_config("/etc/krb5.conf")
    write_config("/etc/idmapd.conf")
    write_config("/etc/default/nfs-common")
    write_config("/etc/init/gssd.conf", "userprincipal")
    write_config("/etc/cups/cupsd.conf")
    write_config("/etc/security/group.conf")

    # FIXME: Hack to get gnome fallback session
#    `cp /usr/share/xsessions/gnome-fallback.desktop /usr/share/ltsp-lightdm/xsessions/ltsp-session.desktop`
    `cp /usr/lib/puavo-ltsp-client/puavo-thin-guest-account /usr/sbin/guest-account`
    `cp /usr/lib/puavo-ltsp-client/puavo-desktop-guest-session /usr/share/ltsp-lightdm/xsession-stub`

    delete_file('/usr/share/dbus-1/system-services/fi.epitest.hostap.WPASupplicant.service')
    delete_file('/usr/share/dbus-1/system-services/fi.w1.wpa_supplicant1.service')
  when "ltspserver"
    write_config("/etc/hosts", "ltspserver")
    write_config("/etc/nsswitch.conf", "sss")
    write_config("/etc/pam.d/ltspguestsshd")
    write_config("/etc/pam.d/ltspsshd")
    write_config("/etc/ldap/ldap.conf")
    write_config("/etc/krb5.conf")
    write_config("/etc/idmapd.conf")
    write_config("/etc/default/nfs-common")
    write_config("/etc/ssh/sshd_config")
    write_config("/etc/cups/client.conf")
    write_config("/etc/ntp.conf")

    @ldap_binddn       = read_file('/etc/puavo/ldap/dn')
    @ldap_bindpw       = read_file('/etc/puavo/ldap/password')
    write_config("/etc/sssd/sssd.conf", nil, true)

    # http://askubuntu.com/questions/117127/flash-video-appears-blue
    # FIXME - do this in ruby instead of perl
    `perl -pi -e 's/libvdpau/lixvdpau/g' /usr/lib/adobe-flashplugin/libflashplayer.so`

    delete_file('/usr/share/dbus-1/system-services/fi.epitest.hostap.WPASupplicant.service')
    delete_file('/usr/share/dbus-1/system-services/fi.w1.wpa_supplicant1.service')

    File.open('/etc/inetd.conf', 'a') do |f|
      f.write("908  stream  tcp     nowait  root    /usr/sbin/tcpd  /usr/lib/puavo-ltsp-client/puavo-ltspserver-create-guest\n")
    end
  when "laptop"
    write_config("/etc/cups/cupsd.conf")
    write_config("/etc/nsswitch.conf", "sss-extrausers")
    write_config("/etc/krb5.conf", "laptop")
    write_config("/etc/idmapd.conf")
    write_config("/etc/ldap/ldap.conf", "laptop")
    write_config("/etc/pam.d/lightdm", "laptop")
    write_config("/etc/pam.d/lightdm-autologin", "laptop")
    write_config("/etc/network/if-up.d/ipsec")
    File.chmod(0755, "/etc/network/if-up.d/ipsec")
    write_config("/etc/network/if-post-down.d/ipsec")
    File.chmod(0755, "/etc/network/if-post-down.d/ipsec")
    write_config("/etc/network/if-up.d/sssd")
    File.chmod(0755, "/etc/network/if-up.d/sssd")
    write_config("/etc/racoon/racoon.conf")
    write_config("/etc/security/group.conf")
    write_config("/etc/samba/smb.conf", "laptop")
    write_config("/etc/ntp.conf")

    # FIXME: Hack to get gnome fallback session
    `cp /usr/share/xsessions/gnome-fallback.desktop /usr/share/ltsp-lightdm/xsessions/ltsp-session.desktop`

    @ldap_binddn       = read_file('/etc/puavo/ldap/dn')
    @ldap_bindpw       = read_file('/etc/puavo/ldap/password')

    write_config("/etc/sssd/sssd.conf", "laptop", true)

    # Make sure that the nss-extrausers database files exist so that
    # sssd does not go into offline mode when using extrausers proxy
    ["/var/lib/extrausers/passwd", "/var/lib/extrausers/group"].each do |filename|
      if !File.exists?(filename)
        File.open(filename, "w") {|f| }
      end
    end

    # Laptops also want the NetworkManager configurations to be done before
    # it starts.  Should that be integrated here is an interesting question,
    # but right now the puavo-update-nm-configurations script loads fileutils
    # and json modules, which would needlessly slow down this script for other
    # host types that do not need this.
    system('puavo-update-nm-configurations')
  when "wirelessaccesspoint"
    wired_interfaces                                                 \
      = Dir.glob('/sys/class/net/eth*')                              \
           .select { |path| not File.exists?("#{ path }/phy80211") } \
           .map    { |path| File.basename(path) }

    File.open('/etc/network/interfaces', 'a') do |file|
      wired_interfaces.each do |interface|
        file.write("\nauto #{ interface }\niface #{ interface } inet dhcp\n")
      end
    end
end

exit(0)
