prefix = /usr/local
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
libdir = $(prefix)/lib
sbindir = $(exec_prefix)/sbin
datarootdir = $(prefix)/share
sysconfdir = $(prefix)/etc

INSTALL = install
INSTALL_PROGRAM = $(INSTALL)
INSTALL_DATA = $(INSTALL) -m 644

.PHONY : all
all :

.PHONY : installdirs
installdirs :
	mkdir -p $(DESTDIR)/sbin
	mkdir -p $(DESTDIR)$(bindir)
	mkdir -p $(DESTDIR)$(libdir)
	mkdir -p $(DESTDIR)$(libdir)/puavo-ltsp-client
	mkdir -p $(DESTDIR)$(libdir)/puavo-ltsp-client/pam
	mkdir -p $(DESTDIR)$(sbindir)
	mkdir -p $(DESTDIR)$(sysconfdir)/default
	mkdir -p $(DESTDIR)$(sysconfdir)/puavo-external-files-actions.d
	mkdir -p $(DESTDIR)$(sysconfdir)/puavo-vpn-client/scripts/route-up
	mkdir -p $(DESTDIR)$(sysconfdir)/init
	mkdir -p $(DESTDIR)$(sysconfdir)/init.d
	mkdir -p $(DESTDIR)$(sysconfdir)/NetworkManager/dispatcher.d
	mkdir -p $(DESTDIR)$(sysconfdir)/ssh
	mkdir -p $(DESTDIR)$(sysconfdir)/xdg/autostart
	mkdir -p $(DESTDIR)/lib/udev/rules.d
	mkdir -p $(DESTDIR)$(sysconfdir)/X11/Xsession.d
	mkdir -p $(DESTDIR)$(datarootdir)/initramfs-tools/scripts/init-bottom
	mkdir -p $(DESTDIR)$(datarootdir)/initramfs-tools/scripts/init-premount
	mkdir -p $(DESTDIR)$(datarootdir)/ltsp/ltsp_config.d
	mkdir -p $(DESTDIR)$(datarootdir)/ltsp/screen.d
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/cups
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/default
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/init
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/ldap
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/network/if-up.d
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/network/if-post-down.d
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/pam.d
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/racoon
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/samba
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/security
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/ssh
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/sssd
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/lib/udev
	mkdir -p $(DESTDIR)$(datarootdir)/puavo-ltsp/init-puavo.d
	mkdir -p $(DESTDIR)/var/lib/puavo-desktop/users

.PHONY : install
install : installdirs
	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp/init-puavo.d \
		init-puavo.d/*-*

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/init \
		templates/etc/init/gssd.conf-userprincipal

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/ssh \
		templates/etc/ssh/sshd_config

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/pam.d \
		templates/etc/pam.d/ltspsshd \
		templates/etc/pam.d/ltspguestsshd \
		templates/etc/pam.d/lightdm-autologin-fatclient \
		templates/etc/pam.d/lightdm-autologin-laptop \
		templates/etc/pam.d/lightdm-autologin-thinclient \
		templates/etc/pam.d/lightdm-fatclient \
		templates/etc/pam.d/lightdm-laptop \
		templates/etc/pam.d/lightdm-thinclient

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/ldap \
		templates/etc/ldap/ldap.conf \
		templates/etc/ldap/ldap.conf-laptop

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/network/if-up.d \
		templates/etc/network/if-up.d/ipsec \
		templates/etc/network/if-up.d/sssd

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/network/if-post-down.d \
		templates/etc/network/if-post-down.d/ipsec

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc \
		templates/etc/hosts \
		templates/etc/hosts-ltspserver \
		templates/etc/idmapd.conf \
		templates/etc/krb5.conf \
		templates/etc/krb5.conf-laptop \
		templates/etc/nsswitch.conf-extrausers \
		templates/etc/nsswitch.conf-sss \
		templates/etc/nsswitch.conf-sss-extrausers \
		templates/etc/ntp.conf

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/cups \
		templates/etc/cups/client.conf \
		templates/etc/cups/cupsd.conf

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/default \
		templates/etc/default/nfs-common

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/racoon \
		templates/etc/racoon/racoon.conf

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/samba \
		templates/etc/samba/smb.conf-laptop

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/security \
		templates/etc/security/group.conf

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/etc/sssd \
		templates/etc/sssd/sssd.conf \
		templates/etc/sssd/sssd.conf-laptop

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/puavo-ltsp-client/templates/lib/udev \
		templates/lib/udev/ltspfs_entry

	$(INSTALL_PROGRAM) -t $(DESTDIR)/sbin \
		init-puavo 

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(bindir) \
		puavo-ltsp-client-action \
		puavo-pulseaudio-setup \
		puavo-pulseaudio-list

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(sbindir) \
		puavo-configure-client \
		puavo-dns-client \
		puavo-dnssd-printer-client \
		puavo-handle-external-files-actions \
		puavo-ltsp-envfeed \
		puavo-ltsp-init-nfs \
		puavo-ltsp-login \
		puavo-ltspserver-create-guest \
		puavo-update-nm-configurations

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(datarootdir)/initramfs-tools/scripts/init-premount \
		initramfs/puavo_udhcp
	$(INSTALL_PROGRAM) -t $(DESTDIR)$(datarootdir)/initramfs-tools/scripts/init-bottom \
		initramfs/puavo_ltsp 

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(datarootdir)/ltsp/screen.d \
		screen.d/register \
		screen.d/wirelessaccesspoint

	$(INSTALL_DATA) -t $(DESTDIR)$(datarootdir)/ltsp/ltsp_config.d \
		ltsp_config.d/00-puavoltsp-by-hosttype \
		ltsp_config.d/02-find-puavo-ltsp-server

	$(INSTALL_DATA) -t $(DESTDIR)$(sysconfdir)/default \
		etc/default/ltspssh \
		etc/default/ltspguestssh

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(sysconfdir)/puavo-vpn-client/scripts/route-up \
		etc/puavo-vpn-client/scripts/route-up/10-dnsmasq \
		etc/puavo-vpn-client/scripts/route-up/20-sssd \
		etc/puavo-vpn-client/scripts/route-up/30-ntpdate

	$(INSTALL_DATA) -t $(DESTDIR)$(sysconfdir)/init.d \
		etc/init.d/ltspssh \
		etc/init.d/ltspguestssh

	$(INSTALL_DATA) -t $(DESTDIR)$(sysconfdir)/init \
		upstart/ltspssh.conf \
		upstart/ltspguestssh.conf \
		upstart/puavo-ltsp-client.conf \
		upstart/puavo-set-sane-date.conf \
		upstart/puavo-sync-external-files.conf

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(sysconfdir)/NetworkManager/dispatcher.d \
		etc/NetworkManager/dispatcher.d/dnssd-printers

	$(INSTALL_DATA) -t $(DESTDIR)$(sysconfdir)/ssh \
		etc/ssh/ltspsshd_config \
		etc/ssh/ltspguestsshd_config

	$(INSTALL_DATA) -t $(DESTDIR)$(sysconfdir)/xdg/autostart \
		etc/xdg/autostart/*

	$(INSTALL_DATA) -t $(DESTDIR)/lib/udev/rules.d \
		udev/rules.d/80-puavo-printers.rules \
		udev/rules.d/95-monitor-hotplug.rules

	$(INSTALL_DATA) -t $(DESTDIR)$(sysconfdir)/X11/Xsession.d \
		etc/X11/Xsession.d/40puavo-retrieve-thinclient-session \
		etc/X11/Xsession.d/41puavo-set-locale \
		etc/X11/Xsession.d/42puavo-set-browser-homepage \
		etc/X11/Xsession.d/43puavo-set-guest-session-quirks \
		etc/X11/Xsession.d/90puavo-setup-printers

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(libdir)/puavo-ltsp-client \
		make-release-logo \
		puavo-desktop-guest-session \
		puavo-thin-guest-account \
		puavo-ltspserver-create-guest \
		udev/udev-hotplug-monitor \
		udev/udev-jetpipe

	$(INSTALL_PROGRAM) -t $(DESTDIR)$(libdir)/puavo-ltsp-client/pam \
		pam/chown-session-dir \
		pam/ltspserver-guest-login \
		pam/make-session-dir \
		pam/open-session \
		pam/populate-extrausers \
		pam/setup-guest-session

	ln -fs /usr/sbin/sshd $(DESTDIR)$(sbindir)/ltspsshd
	ln -fs /usr/sbin/sshd $(DESTDIR)$(sbindir)/ltspguestsshd

.PHONY : clean
clean :
